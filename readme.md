# Шаблоны CI/CD процессов

## Workflows

### deploy

Пайплайн запускается при пуше в основную ветку. Последовательно вызываются команды линтера, тестов, билда образа и отправки его в регистри, а также деплой на самом сервере.

### restart

Запускаемы в ручную пайплайн, который позволяет перекачать заново образы и сбилдить докер композ, перезапустив сервис.

### build

TODO describe

### lint

TODO describe

### test

TODO describe

Подготовка:
1. Обновляем (добавляем Makefile) с командами из корневого каталога этого проекта. Помещаем его в папку с Dockerfile. Комментарии у переменных registry и image убираем.
1. Добавляем в Makefile команды из соответвующей папки.
1. Пробуем сбилдить образ командой make build.
1. Проверяем в api хаба, что образ появился.
1. Исправляем файл docker-compose.yml на новые образы.
1. Проверяем работоспособность командой make run.
1. Добавляем github actions путем копирования файлов deploy.yml и restart.yml.

Настройка:
1. Добавляем значения переменных среды для проекта. В репозитории гитхаба переходим в раздел Settings -> Secrets and Variables -> Actions
1. Добавляем имя пользователя для доступа через ssh в variable - SSH_USER
1. ip хоста для подключения через ssh в variable - SSH_HOST
1. Добавляем переменную SSH_PROJECT_PATH в variable. Указываем в ней путь до Makefile.
1. ssh private key. Части ключа (публичный и приватный) могут быть сгенерированы в любом месте, но лучше их хранить на самом хосте. В secrets SSH_PRIVATE_KEY репозитория копируем содержание приватной части ключа. Проверяем, что его публичная часть из файла *.pub добавлена в файл ~/.ssh/authorized_keys
1. [Deprecated] В шаге Restart service скрипта .github/workflows/restart.yml исправляем полный путь до каталога, в котором лежит Makefile
1. Добавляем в переменные HUB_HOST и HUB_USER имя пользователя для хаба и его адрес.
1. В секретные переменные добавляем HUB_PASS.
